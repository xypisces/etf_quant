## Context

当前系统通过 `print()` 将回测报告和月度收益表直接输出到终端，每次运行后报告即丢失。仪表板图片保存在扁平的 `results/` 目录下，无时间戳，多次运行会覆盖历史结果。

已有模块：
- `src/backtest/metrics.py`: 五维度报告、月度收益矩阵生成（当前只支持 `print`）
- `src/utils/plotting.py`: 仪表板图表生成（当前保存到 `results/`）
- `src/main.py`: 主入口脚本（当前负责组装和调用报告）

## Goals / Non-Goals

**Goals:**
- 回测报告持久化到 Markdown 文件，支持多策略增量追加
- 按标的代码分目录组织结果（`results/<symbol>/`）
- 自动生成策略对比汇总表（含买入持有基准），对比累计收益率
- 仪表板图片带时间戳命名，避免覆盖历史

**Non-Goals:**
- 不改变回测引擎核心逻辑
- 不实现 Web UI 或交互式报告
- 不改变 metrics 中各指标的计算公式

## Decisions

### 1. 新增 `src/utils/reporter.py` 模块

**决策**: 创建独立的 `ReportWriter` 类负责 Markdown 报告的生成和增量更新。

**理由**: 将报告输出逻辑与指标计算逻辑解耦。`metrics.py` 负责纯计算和格式化字符串，`reporter.py` 负责文件 I/O 和报告结构管理。

**替代方案**: 直接在 `metrics.py` 中添加文件写入——但这违反单一职责原则。

### 2. 报告文件结构设计

**决策**: 每个标的一个 `report.md` 文件，每次回测追加一个二级标题段落。

```
results/
  600938/
    report.md          # 包含所有策略的回测报告
    dashboard_MACross_20260215_110245.png
    dashboard_Turtle_20260215_120000.png
```

报告 Markdown 结构:
```markdown
# 回测报告: 600938
<!-- 自动生成，请勿手动编辑 -->

## MACross(5,20) — 2026-02-15

### 收益指标 (Returns)
...
### 月度收益矩阵
...

---

## 策略对比汇总
| 策略 | 累计收益率 | ... |
```

**理由**: 一个文件包含所有策略便于内联对比。用 `---` 分隔各策略段落确保可读性。

### 3. `metrics.py` 重构：`print_report` → `format_report`

**决策**: 将 `print_report` 改为 `format_report`，返回格式化的 Markdown 字符串而不是直接打印。同时提供 `format_monthly_table` 函数。

**理由**: 分离"格式化"和"输出"两个关注点，让 `reporter.py` 和终端打印都能复用格式化结果。

### 4. 策略对比汇总表

**决策**: `ReportWriter` 在每次追加后重新扫描文件中所有策略段落，提取累计收益率，生成对比表。基准收益率（买入持有）作为一行单独计算并加入。

**理由**: 避免维护外部状态文件，报告文件自身就是数据源。

### 5. 仪表板命名规则

**决策**: `dashboard_{策略名}_{YYYYMMDD}_{HHMMSS}.png`

**理由**: 包含策略名和精确时间戳，可按策略或时间排序查找。

## Risks / Trade-offs

- **[文件解析脆弱性]** → 对比汇总表依赖解析自身生成的 Markdown，如用户手动编辑报告可能导致解析失败。缓解：添加 HTML 注释标记作为解析锚点。

- **[报告文件增长]** → 长期运行多策略后报告文件可能变得较长。缓解：每个策略段落保持精简，后续可考虑按年归档。
